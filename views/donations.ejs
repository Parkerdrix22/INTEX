<!--
    PAGE: Donations (donations.ejs)
    
    DEVELOPERS:
    - Parker Hendrix
    - Brandon Price
    - Isaac Johnson
    - Zach Hada
    
    OVERVIEW:
    This page handles donations. Regular users can submit donations and choose an amount.
    Managers see analytics like total donations and total amount. Managers can also search
    for participants to see their donation history and add/edit/delete donations.
-->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Donations - Ella Rises</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Fonts - DM Serif Display -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&display=swap" rel="stylesheet">
    <style>
        :root {
            --er-pink: #FFD8D1;
            --er-pink-dark: #ff9fc4;
            --er-text: #222222;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        body {
            background-color: #ffffff;
            color: var(--er-text);
        }

        /* Wrapper for sticky footer */
        .page-wrap {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* DM Serif Display for all titles and headers */
        h1,
        h2,
        h3,
        h4,
        h5,
        h6,
        .navbar-brand {
            font-family: 'DM Serif Display', serif;
        }

        /* Light pink navbar */
        .navbar {
            background-color: var(--er-pink) !important;
            padding: 0.8rem 0;
            min-height: 55px;
        }

        .navbar .container {
            padding-left: 1rem;
            max-width: 1600px;
            width: 100%;
        }

        body .container {
            max-width: 1400px;
        }

        .navbar-brand {
            font-weight: 700;
            letter-spacing: 0.06em;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-left: 0 !important;
            padding-left: 0 !important;
        }

        .navbar-brand img {
            height: 50px;
            width: auto;
        }

        .nav-link {
            font-weight: 500;
            margin: 0 0.75rem;
        }

        /* Top bar for authentication links */
        .top-bar {
            background-color: var(--er-pink);
            padding: 0.5rem 0;
            font-size: 0.9rem;
        }

        .top-bar .container {
            max-width: 1600px;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding-left: 1rem;
            padding-right: 1rem;
        }

        .top-bar-links {
            display: flex;
            gap: 0;
            align-items: center;
            background-color: #ffffff;
            border-radius: 50px;
            padding: 0.25rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .top-bar-link {
            color: #000000;
            text-decoration: none;
            font-weight: 500;
            padding: 0.5rem 1rem;
            transition: color 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .top-bar-link:hover {
            color: var(--er-pink-dark);
        }

        .top-bar-link:not(:last-child) {
            border-right: 1px solid var(--er-pink);
        }

        .top-bar-link svg {
            width: 18px;
            height: 18px;
            fill: currentColor;
        }

        /* Page Header */
        .page-header {
            background-color: var(--er-pink);
            padding: 4rem 2rem;
            text-align: center;
            margin-bottom: 3rem;
        }

        .page-header h1 {
            font-size: 3rem;
            font-weight: 700;
            color: var(--er-text);
            margin-bottom: 1rem;
        }

        .page-header p {
            font-size: 1.2rem;
            color: #666;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.6;
        }

        /* Donation Form */
        .donation-form-container {
            max-width: 600px;
            margin: 0 auto 4rem;
            padding: 0 2rem;
        }

        .donation-form {
            background-color: #f8f9fa;
            border-radius: 1rem;
            padding: 3rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            font-weight: 600;
            color: var(--er-text);
            margin-bottom: 0.5rem;
            display: block;
        }

        .form-control,
        .form-select {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid #e0e0e0;
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-control:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--er-pink-dark);
            box-shadow: 0 0 0 0.2rem rgba(255, 159, 196, 0.25);
        }

        .donation-amount-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .donation-amount-btn {
            padding: 1rem;
            border: 2px solid var(--er-pink);
            background-color: #ffffff;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .donation-amount-btn:hover {
            background-color: var(--er-pink);
            border-color: var(--er-pink-dark);
        }

        .donation-amount-btn.selected {
            background-color: var(--er-pink-dark);
            color: #ffffff;
            border-color: var(--er-pink-dark);
        }

        .submit-donation-btn {
            width: 100%;
            padding: 1rem 2rem;
            background-color: var(--er-pink-dark);
            color: #ffffff;
            border: none;
            border-radius: 0.5rem;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 1.5rem;
        }

        .submit-donation-btn:hover {
            background-color: #ff8ab8;
        }

        .submit-donation-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        /* Footer */
        footer {
            background-color: var(--er-pink);
            padding: 3rem 1rem 2rem;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            margin-top: auto;
        }

        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
        }

        .footer-section {
            margin-bottom: 2rem;
        }

        .footer-section h4 {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .footer-section p,
        .footer-section a {
            color: var(--er-text);
            text-decoration: none;
            font-size: 0.95rem;
            line-height: 1.6;
        }

        .footer-section a:hover {
            color: var(--er-pink-dark);
        }

        .footer-logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .footer-logo img {
            height: 40px;
            width: auto;
        }

        .footer-logo span {
            font-weight: 700;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            font-size: 1.2rem;
        }

        .footer-bottom {
            text-align: center;
            padding-top: 2rem;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            margin-top: 2rem;
            color: #666;
            font-size: 0.9rem;
        }

        .footer-main {
            display: flex;
            gap: 3rem;
            align-items: flex-start;
        }

        .footer-left {
            flex: 1;
        }

        .footer-divider {
            width: 1px;
            background-color: rgba(0, 0, 0, 0.2);
            min-height: 150px;
        }

        .footer-right {
            flex: 1;
        }

        .social-links {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            align-items: center;
        }

        .social-link {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--er-text);
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .social-link:hover {
            color: var(--er-pink-dark);
        }

        .social-icon {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }

        /* Manager Dashboard Section */
        .manager-dashboard-section {
            background-color: #fafafa;
            padding: 4rem 2rem;
            margin-bottom: 4rem;
        }

        .stats-container-simple {
            display: flex;
            gap: 2rem;
            justify-content: center;
            max-width: 800px;
            margin: 0 auto;
        }

        .stats-container-simple .stat-card {
            flex: 1;
            background-color: #ffffff;
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
            min-width: 250px;
        }

        .stat-label {
            font-size: 1.1rem;
            color: #666;
            margin-bottom: 1rem;
            font-weight: 600;
        }

        .stat-number {
            font-size: 4rem;
            font-weight: 700;
            color: var(--er-pink-dark);
            font-family: 'DM Serif Display', serif;
        }

        /* Donation Search Results */
        .donation-item {
            padding: 1rem;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .donation-item:last-child {
            border-bottom: none;
        }

        .donation-date {
            color: #666;
            font-size: 0.95rem;
        }

        .donation-amount {
            font-weight: 600;
            color: var(--er-pink-dark);
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .donation-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .donation-action-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            transition: color 0.2s;
        }

        .donation-action-btn:hover {
            color: var(--er-pink-dark);
        }

        .donation-action-btn svg {
            width: 18px;
            height: 18px;
        }

        .donations-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .add-donation-btn {
            background-color: var(--er-pink);
            color: #fff;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s;
        }

        .add-donation-btn:hover {
            background-color: var(--er-pink-dark);
        }

        .no-donations {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .participant-name {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--er-text);
            margin-bottom: 0.5rem;
        }

        .participant-email {
            color: #666;
            font-size: 0.95rem;
        }

        /* Participant Dropdown */
        .participant-dropdown-item {
            padding: 1rem;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s;
        }

        .participant-dropdown-item:hover {
            background-color: var(--er-pink);
        }

        .participant-dropdown-item:last-child {
            border-bottom: none;
        }

        .participant-dropdown-name {
            font-weight: 600;
            color: var(--er-text);
            margin-bottom: 0.25rem;
        }

        .participant-dropdown-email {
            color: #666;
            font-size: 0.9rem;
        }

        .no-results {
            padding: 1rem;
            text-align: center;
            color: #666;
        }

        @media (max-width: 767px) {
            .page-header {
                padding: 3rem 1.5rem;
            }

            .page-header h1 {
                font-size: 2rem;
            }

            .donation-form-container {
                padding: 0 1rem;
            }

            .donation-form {
                padding: 2rem 1.5rem;
            }

            .donation-amount-options {
                grid-template-columns: repeat(2, 1fr);
            }

            .footer-main {
                flex-direction: column;
            }

            .footer-divider {
                width: 100%;
                height: 1px;
                min-height: 1px;
                margin: 1.5rem 0;
            }

            .manager-dashboard-section {
                padding: 3rem 1rem;
            }

            .stats-container-simple {
                flex-direction: column;
                gap: 1.5rem;
            }

            .stat-number {
                font-size: 3rem;
            }
        }
    </style>
</head>

<body>
    <div class="page-wrap">
    <!-- Top bar for authentication links -->
    <div class="top-bar">
        <div class="container">
            <div class="top-bar-links">
                <% if (!user) { %>
                    <a href="/login" class="top-bar-link">Sign In / Create Account</a>
                <% } else { %>
                    <a href="/logout" class="top-bar-link">Logout</a>
                    <a href="/profile" class="top-bar-link">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                        </svg>
                    </a>
                <% } %>
            </div>
        </div>
    </div>

    <!-- Light pink navbar -->
    <nav class="navbar navbar-expand-md navbar-light">
        <div class="container">
            <a class="navbar-brand" href="/">
                <img src="/images/ella_logo.avif" alt="Ella Rises Logo">
                <span>Ella Rises</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navContent"
                aria-controls="navContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navContent">
                <ul class="navbar-nav ms-auto mb-2 mb-md-0">
                    <% if (user && user.isManager) { %>
                    <li class="nav-item">
                        <a class="nav-link" href="/participants">Participants</a>
                    </li>
                    <% } %>
                    <li class="nav-item">
                        <a class="nav-link" href="/events">Events</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/survey">Event Feedback</a>
                    </li>
                    <% if (user && user.isUser) { %>
                        <li class="nav-item">
                            <a class="nav-link" href="/my-journey">My Journey | Mi Camino</a>
                        </li>
                    <% } %>
                    <% if (user && user.isManager) { %>
                        <li class="nav-item">
                            <a class="nav-link" href="/milestones">Milestones</a>
                        </li>
                    <% } %>
                    <li class="nav-item">
                        <a class="nav-link" href="/donations">Donations</a>
                    </li>
                    <% if (user && user.isManager) { %>
                        <li class="nav-item">
                            <a class="nav-link" href="/dashboard">Dashboard</a>
                        </li>
                    <% } %>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Page Header -->
    <div class="page-header">
        <h1>Donate to Ella Rises</h1>
        <p>
            Your generous donations help empower young women to pursue higher education and embrace their cultural heritage 
            through STEAM programs, mentoring, and leadership opportunities. Every contribution makes a difference in the lives 
            of these incredible girls.
        </p>
    </div>

    <!-- Manager Dashboard Section -->
    <% if (user && user.isManager) { %>
        <div class="manager-dashboard-section">
            <div class="container">
                <h2 style="font-family: 'DM Serif Display', serif; text-align: center; margin-bottom: 2rem;">Donation Analytics</h2>
                
                <!-- Stats Container -->
                <div class="stats-container-simple">
                    <div class="stat-card">
                        <div class="stat-label">Total Donations</div>
                        <div class="stat-number" id="totalDonations">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Amount</div>
                        <div class="stat-number" id="totalAmount">$0.00</div>
                    </div>
                </div>

                <!-- Participant Search Section -->
                <div style="max-width: 800px; margin: 3rem auto 0;">
                    <h3 style="font-family: 'DM Serif Display', serif; text-align: center; margin-bottom: 1.5rem;">Search Participant Donations</h3>
                    <div style="position: relative; margin-bottom: 2rem;">
                        <input type="text" id="participantSearch" class="form-control" placeholder="Type to search by first name or last name..." style="width: 100%;">
                        <div id="participantDropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background-color: #fff; border: 2px solid var(--er-pink); border-top: none; border-radius: 0 0 0.5rem 0.5rem; max-height: 300px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);"></div>
                    </div>
                    
                    <!-- Search Results -->
                    <div id="donationSearchResults" style="display: none;">
                        <div id="participantInfo" style="background-color: #fff; padding: 1.5rem; border-radius: 0.75rem; margin-bottom: 1.5rem; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);"></div>
                        <div id="donationsList" style="background-color: #fff; padding: 1.5rem; border-radius: 0.75rem; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);"></div>
                    </div>
                    
                    <!-- Add/Edit Donation Modal -->
                    <div class="modal fade" id="donationModal" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="donationModalTitle">Add Donation</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <form id="donationFormModal">
                                        <input type="hidden" id="modalDonationId" value="">
                                        <input type="hidden" id="modalParticipantId" value="">
                                        <div class="mb-3">
                                            <label for="modalDonationAmount" class="form-label">Donation Amount ($)</label>
                                            <input type="number" class="form-control" id="modalDonationAmount" step="0.01" min="0.01" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="modalDonationDate" class="form-label">Donation Date</label>
                                            <input type="date" class="form-control" id="modalDonationDate" required>
                                        </div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button type="button" class="btn btn-primary" id="saveDonationBtn">Save</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    <% } %>

    <!-- Donation Form -->
    <% if (!user || !user.isManager) { %>
    <div class="donation-form-container">
        <form class="donation-form" id="donationForm">
            <div class="form-group">
                <label class="form-label">Select Donation Amount</label>
                <div class="donation-amount-options">
                    <button type="button" class="donation-amount-btn" data-amount="25">$25</button>
                    <button type="button" class="donation-amount-btn" data-amount="50">$50</button>
                    <button type="button" class="donation-amount-btn" data-amount="100">$100</button>
                    <button type="button" class="donation-amount-btn" data-amount="250">$250</button>
                    <button type="button" class="donation-amount-btn" data-amount="500">$500</button>
                    <button type="button" class="donation-amount-btn" data-amount="1000">$1,000</button>
                </div>
                <input type="number" class="form-control" id="customAmount" placeholder="Or enter custom amount" min="1" step="0.01">
            </div>

            <button type="submit" class="submit-donation-btn" id="submitDonationBtn">
                Submit Donation & Enter Card Info
            </button>
        </form>
    </div>
    <% } %>

    <!-- Footer -->
    <footer>
        <div class="footer-content">
            <div class="footer-main">
                <div class="footer-left">
                    <div class="footer-logo">
                        <img src="/images/ella_logo.avif" alt="Ella Rises Logo">
                        <span>Ella Rises</span>
                    </div>
                    <p>
                        Empowering the rising generation of women to pursue higher education
                        and embrace their heritage through STEAM programs, mentoring, and
                        leadership opportunities.
                    </p>
                </div>

                <div class="footer-divider"></div>

                <div class="footer-right">
                    <h4>Contact</h4>
                    <p>Visit us at:</p>
                    <p><a href="https://www.ellarises.org/" target="_blank">www.ellarises.org</a></p>
                    <div class="social-links">
                        <a href="https://www.instagram.com/ellarises/" target="_blank" class="social-link">
                            <svg class="social-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path
                                    d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.98-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.98-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z" />
                            </svg>
                            <span>Instagram</span>
                        </a>
                        <a href="https://www.facebook.com/EllaRises" target="_blank" class="social-link">
                            <svg class="social-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path
                                    d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z" />
                            </svg>
                            <span>Facebook</span>
                        </a>
                    </div>
                </div>
            </div>

            <div class="footer-bottom">
                <p>&copy; 2025 Ella Rises. All rights reserved.</p>
            </div>
        </div>
    </footer>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        // Restore donation amount from sessionStorage if returning from login
        window.addEventListener('DOMContentLoaded', function() {
            const pendingAmount = sessionStorage.getItem('pendingDonationAmount');
            const customAmountInput = document.getElementById('customAmount');
            if (pendingAmount && customAmountInput) {
                // Set the custom amount input
                customAmountInput.value = pendingAmount;
                // Clear sessionStorage
                sessionStorage.removeItem('pendingDonationAmount');
                sessionStorage.removeItem('pendingDonationReturnUrl');
            }
        });

        // Handle donation amount selection (only if form exists)
        const amountButtons = document.querySelectorAll('.donation-amount-btn');
        const customAmountInput = document.getElementById('customAmount');
        const donationForm = document.getElementById('donationForm');
        let selectedAmount = null;

        // Only set up form handlers if the form elements exist (not for managers)
        if (amountButtons.length > 0 && customAmountInput && donationForm) {
            amountButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    // Remove selected class from all buttons
                    amountButtons.forEach(b => b.classList.remove('selected'));
                    // Add selected class to clicked button
                    this.classList.add('selected');
                    selectedAmount = this.getAttribute('data-amount');
                    // Clear custom amount input
                    customAmountInput.value = '';
                });
            });

            // Handle custom amount input
            customAmountInput.addEventListener('input', function() {
                // Remove selected class from all buttons when custom amount is entered
                amountButtons.forEach(b => b.classList.remove('selected'));
                selectedAmount = this.value;
            });

            // Handle form submission
            donationForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Get the selected amount first
            const amount = customAmountInput.value || selectedAmount;
            
            if (!amount || parseFloat(amount) <= 0) {
                alert('Please select or enter a donation amount.');
                return;
            }
            
            // Check if user is logged in
            <% if (!user) { %>
                // User is not logged in - redirect to login page
                // Store the donation amount in sessionStorage to restore after login
                sessionStorage.setItem('pendingDonationAmount', amount);
                sessionStorage.setItem('pendingDonationReturnUrl', '/donations');
                alert('Please sign in or create an account to continue with your donation.');
                window.location.href = '/login';
                return;
            <% } %>
            
            // User is logged in - proceed with donation
            // Format amount for display
            const formattedAmount = parseFloat(amount).toLocaleString('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2
            });

            // Confirm submission
            const confirmed = confirm(`Are you sure you want to submit a donation of ${formattedAmount}?\n\nClick OK to confirm or Cancel to go back.`);
            
            if (!confirmed) {
                return; // User cancelled
            }

            // User confirmed - save to database first, then redirect to Givebutter
            const submitBtn = document.getElementById('submitDonationBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Processing...';

            fetch('/donations/submit', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    donationAmount: amount
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Donation saved successfully - open Givebutter in new tab
                    window.open(data.givebutterUrl || 'https://givebutter.com/EllaRises', '_blank');
                    // Reset form and button
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Submit Donation & Enter Card Info';
                    document.getElementById('donationForm').reset();
                    amountButtons.forEach(b => b.classList.remove('selected'));
                    selectedAmount = null;
                } else {
                    // Error saving donation
                    alert('Error: ' + (data.error || 'Failed to save donation. Please try again.'));
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Submit Donation & Enter Card Info';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Donation & Enter Card Info';
            });
            });
        }

        <% if (user && user.isManager) { %>
        // Manager Dashboard - Load Donation Totals
        async function loadDonationData() {
            try {
                const response = await fetch('/api/donations/data');
                const result = await response.json();

                if (result.success) {
                    const data = result.data;
                    
                    // Update total donations
                    document.getElementById('totalDonations').textContent = data.totalDonations;
                    
                    // Update total amount - round to nearest whole dollar
                    const roundedAmount = Math.round(data.totalAmount);
                    const formattedAmount = roundedAmount.toLocaleString('en-US', {
                        style: 'currency',
                        currency: 'USD',
                        minimumFractionDigits: 0,
                        maximumFractionDigits: 0
                    });
                    document.getElementById('totalAmount').textContent = formattedAmount;
                }
            } catch (error) {
                console.error('Error loading donation data:', error);
            }
        }

        // Debounce function to limit API calls
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Search participants as user types
        async function searchParticipants(searchTerm) {
            const dropdown = document.getElementById('participantDropdown');
            
            if (!searchTerm || searchTerm.trim().length < 2) {
                dropdown.style.display = 'none';
                return;
            }

            try {
                const response = await fetch(`/api/donations/search-participants?name=${encodeURIComponent(searchTerm)}`);
                const result = await response.json();

                if (result.success && result.participants && result.participants.length > 0) {
                    let dropdownHTML = '';
                    result.participants.forEach(participant => {
                        dropdownHTML += `
                            <div class="participant-dropdown-item" onclick="selectParticipant(${participant.participantid}, '${(participant.participantfirstname || '').replace(/'/g, "\\'")}', '${(participant.participantlastname || '').replace(/'/g, "\\'")}', '${(participant.participantemail || '').replace(/'/g, "\\'")}')">
                                <div class="participant-dropdown-name">${participant.participantfirstname || ''} ${participant.participantlastname || ''}</div>
                                <div class="participant-dropdown-email">${participant.participantemail || ''}</div>
                            </div>
                        `;
                    });
                    dropdown.innerHTML = dropdownHTML;
                    dropdown.style.display = 'block';
                } else {
                    dropdown.innerHTML = '<div class="no-results">No participants found</div>';
                    dropdown.style.display = 'block';
                }
            } catch (error) {
                console.error('Error searching participants:', error);
                dropdown.innerHTML = '<div class="no-results">Error searching participants</div>';
                dropdown.style.display = 'block';
            }
        }

        // Select a participant and show their donations
        async function selectParticipant(participantId, firstName, lastName, email) {
            // Hide dropdown and update search input
            document.getElementById('participantDropdown').style.display = 'none';
            document.getElementById('participantSearch').value = `${firstName} ${lastName}`;

            try {
                const response = await fetch(`/api/donations/participant/${participantId}`);
                const result = await response.json();

                const resultsDiv = document.getElementById('donationSearchResults');
                const participantInfoDiv = document.getElementById('participantInfo');
                const donationsListDiv = document.getElementById('donationsList');

                if (result.success) {
                    // Display participant info
                    participantInfoDiv.innerHTML = `
                        <div class="participant-name">${firstName} ${lastName}</div>
                        <div class="participant-email">${email}</div>
                    `;

                    // Display donations
                    if (result.donations && result.donations.length > 0) {
                        let donationsHTML = `
                            <div class="donations-header">
                                <h4 style="margin: 0; font-weight: 600;">Donations:</h4>
                                <button type="button" class="add-donation-btn" onclick="openAddDonationModal(${participantId})">
                                    + Add Donation
                                </button>
                            </div>
                        `;
                        result.donations.forEach(donation => {
                            // Handle VARCHAR date format - could be "YYYY-MM-DD" or "UNKNOWN_DATE"
                            let formattedDate = 'Unknown Date';
                            const dateStr = donation.donationdate;
                            
                            if (dateStr && dateStr !== 'UNKNOWN_DATE' && dateStr.trim() !== '') {
                                // Try to parse YYYY-MM-DD format
                                const dateMatch = dateStr.match(/^(\d{4})-(\d{2})-(\d{2})/);
                                if (dateMatch) {
                                    const year = parseInt(dateMatch[1], 10);
                                    const month = parseInt(dateMatch[2], 10) - 1;
                                    const day = parseInt(dateMatch[3], 10);
                                    const date = new Date(year, month, day);
                                    if (!isNaN(date.getTime())) {
                                        formattedDate = date.toLocaleDateString('en-US', {
                                            year: 'numeric',
                                            month: 'long',
                                            day: 'numeric'
                                        });
                                    } else {
                                        formattedDate = dateStr;
                                    }
                                } else {
                                    // Try parsing as-is
                                    const date = new Date(dateStr);
                                    if (!isNaN(date.getTime())) {
                                        formattedDate = date.toLocaleDateString('en-US', {
                                            year: 'numeric',
                                            month: 'long',
                                            day: 'numeric'
                                        });
                                    } else {
                                        formattedDate = dateStr;
                                    }
                                }
                            } else if (dateStr === 'UNKNOWN_DATE') {
                                formattedDate = 'Unknown Date';
                            }
                            
                            const formattedAmount = parseFloat(donation.donationamount || 0).toLocaleString('en-US', {
                                style: 'currency',
                                currency: 'USD',
                                minimumFractionDigits: 2
                            });
                            // Format date for input field (YYYY-MM-DD)
                            let inputDate = 'UNKNOWN_DATE';
                            if (dateStr && dateStr !== 'UNKNOWN_DATE' && dateStr.trim() !== '') {
                                const dateMatch = dateStr.match(/^(\d{4})-(\d{2})-(\d{2})/);
                                if (dateMatch) {
                                    inputDate = dateStr.substring(0, 10);
                                } else {
                                    const date = new Date(dateStr);
                                    if (!isNaN(date.getTime())) {
                                        const year = date.getFullYear();
                                        const month = String(date.getMonth() + 1).padStart(2, '0');
                                        const day = String(date.getDate()).padStart(2, '0');
                                        inputDate = `${year}-${month}-${day}`;
                                    }
                                }
                            }
                            
                            donationsHTML += `
                                <div class="donation-item">
                                    <div>
                                        <div class="donation-date">${formattedDate}</div>
                                    </div>
                                    <div class="donation-amount">
                                        ${formattedAmount}
                                        <div class="donation-actions">
                                            <button type="button" class="donation-action-btn" onclick="editDonation(${donation.donationid}, ${participantId}, ${donation.donationamount}, '${inputDate}')" title="Edit">
                                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                                </svg>
                                            </button>
                                            <button type="button" class="donation-action-btn" onclick="deleteDonation(${donation.donationid}, ${participantId})" title="Delete">
                                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                </svg>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        donationsListDiv.innerHTML = donationsHTML;
                    } else {
                        donationsListDiv.innerHTML = `
                            <div class="donations-header">
                                <h4 style="margin: 0; font-weight: 600;">Donations:</h4>
                                <button type="button" class="add-donation-btn" onclick="openAddDonationModal(${participantId})">
                                    + Add Donation
                                </button>
                            </div>
                            <div class="no-donations">No donations found for this participant.</div>
                        `;
                    }

                    resultsDiv.style.display = 'block';
                } else {
                    alert('Error loading donations for this participant.');
                }
            } catch (error) {
                console.error('Error loading participant donations:', error);
                alert('Error loading donations. Please try again.');
            }
        }

        // Set up search input with debouncing
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('participantSearch');
            if (searchInput) {
                const debouncedSearch = debounce(searchParticipants, 300);
                
                searchInput.addEventListener('input', function(e) {
                    debouncedSearch(e.target.value);
                });

                // Hide dropdown when clicking outside
                document.addEventListener('click', function(e) {
                    const dropdown = document.getElementById('participantDropdown');
                    if (dropdown && !searchInput.contains(e.target) && !dropdown.contains(e.target)) {
                        dropdown.style.display = 'none';
                    }
                });
            }
        });

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadDonationData();
        });

        // Store current participant ID for donation operations
        let currentParticipantId = null;

        // Open add donation modal
        function openAddDonationModal(participantId) {
            currentParticipantId = participantId;
            document.getElementById('donationModalTitle').textContent = 'Add Donation';
            document.getElementById('modalDonationId').value = '';
            document.getElementById('modalParticipantId').value = participantId;
            document.getElementById('modalDonationAmount').value = '';
            
            // Set today's date
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            document.getElementById('modalDonationDate').value = `${year}-${month}-${day}`;
            
            const modal = new bootstrap.Modal(document.getElementById('donationModal'));
            modal.show();
        }

        // Edit donation
        function editDonation(donationId, participantId, amount, date) {
            currentParticipantId = participantId;
            document.getElementById('donationModalTitle').textContent = 'Edit Donation';
            document.getElementById('modalDonationId').value = donationId;
            document.getElementById('modalParticipantId').value = participantId;
            document.getElementById('modalDonationAmount').value = amount;
            document.getElementById('modalDonationDate').value = date === 'UNKNOWN_DATE' ? '' : date;
            
            const modal = new bootstrap.Modal(document.getElementById('donationModal'));
            modal.show();
        }

        // Delete donation
        async function deleteDonation(donationId, participantId) {
            if (!confirm('Are you sure you want to delete this donation?')) {
                return;
            }

            try {
                const response = await fetch(`/api/donations/${donationId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (result.success) {
                    // Update total donations and total amount
                    loadDonationData();
                    
                    // Reload donations for this participant
                    // Get participant info from the displayed info
                    const participantInfoDiv = document.getElementById('participantInfo');
                    if (participantInfoDiv && participantInfoDiv.innerHTML) {
                        const participantName = participantInfoDiv.querySelector('.participant-name')?.textContent || '';
                        const participantEmail = participantInfoDiv.querySelector('.participant-email')?.textContent || '';
                        
                        if (participantName && participantEmail) {
                            const nameParts = participantName.trim().split(/\s+/);
                            const firstName = nameParts[0] || '';
                            const lastName = nameParts.slice(1).join(' ') || '';
                            await selectParticipant(participantId, firstName, lastName, participantEmail);
                        } else {
                            // Fallback: just reload donations without participant info
                            const response = await fetch(`/api/donations/participant/${participantId}`);
                            const result = await response.json();
                            if (result.success) {
                                const donationsListDiv = document.getElementById('donationsList');
                                // Reuse the display logic from selectParticipant
                                if (result.donations && result.donations.length > 0) {
                                    let donationsHTML = `
                                        <div class="donations-header">
                                            <h4 style="margin: 0; font-weight: 600;">Donations:</h4>
                                            <button type="button" class="add-donation-btn" onclick="openAddDonationModal(${participantId})">
                                                + Add Donation
                                            </button>
                                        </div>
                                    `;
                                    result.donations.forEach(donation => {
                                        // Format date and amount (reuse logic from selectParticipant)
                                        let formattedDate = 'Unknown Date';
                                        const dateStr = donation.donationdate;
                                        if (dateStr && dateStr !== 'UNKNOWN_DATE' && dateStr.trim() !== '') {
                                            const dateMatch = dateStr.match(/^(\d{4})-(\d{2})-(\d{2})/);
                                            if (dateMatch) {
                                                const year = parseInt(dateMatch[1], 10);
                                                const month = parseInt(dateMatch[2], 10) - 1;
                                                const day = parseInt(dateMatch[3], 10);
                                                const date = new Date(year, month, day);
                                                if (!isNaN(date.getTime())) {
                                                    formattedDate = date.toLocaleDateString('en-US', {
                                                        year: 'numeric',
                                                        month: 'long',
                                                        day: 'numeric'
                                                    });
                                                } else {
                                                    formattedDate = dateStr;
                                                }
                                            } else {
                                                const date = new Date(dateStr);
                                                if (!isNaN(date.getTime())) {
                                                    formattedDate = date.toLocaleDateString('en-US', {
                                                        year: 'numeric',
                                                        month: 'long',
                                                        day: 'numeric'
                                                    });
                                                } else {
                                                    formattedDate = dateStr;
                                                }
                                            }
                                        } else if (dateStr === 'UNKNOWN_DATE') {
                                            formattedDate = 'Unknown Date';
                                        }
                                        
                                        const formattedAmount = parseFloat(donation.donationamount || 0).toLocaleString('en-US', {
                                            style: 'currency',
                                            currency: 'USD',
                                            minimumFractionDigits: 2
                                        });
                                        
                                        let inputDate = 'UNKNOWN_DATE';
                                        if (dateStr && dateStr !== 'UNKNOWN_DATE' && dateStr.trim() !== '') {
                                            const dateMatch = dateStr.match(/^(\d{4})-(\d{2})-(\d{2})/);
                                            if (dateMatch) {
                                                inputDate = dateStr.substring(0, 10);
                                            } else {
                                                const date = new Date(dateStr);
                                                if (!isNaN(date.getTime())) {
                                                    const year = date.getFullYear();
                                                    const month = String(date.getMonth() + 1).padStart(2, '0');
                                                    const day = String(date.getDate()).padStart(2, '0');
                                                    inputDate = `${year}-${month}-${day}`;
                                                }
                                            }
                                        }
                                        
                                        donationsHTML += `
                                            <div class="donation-item">
                                                <div>
                                                    <div class="donation-date">${formattedDate}</div>
                                                </div>
                                                <div class="donation-amount">
                                                    ${formattedAmount}
                                                    <div class="donation-actions">
                                                        <button type="button" class="donation-action-btn" onclick="editDonation(${donation.donationid}, ${participantId}, ${donation.donationamount}, '${inputDate}')" title="Edit">
                                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                                            </svg>
                                                        </button>
                                                        <button type="button" class="donation-action-btn" onclick="deleteDonation(${donation.donationid}, ${participantId})" title="Delete">
                                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                            </svg>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    });
                                    donationsListDiv.innerHTML = donationsHTML;
                                } else {
                                    donationsListDiv.innerHTML = `
                                        <div class="donations-header">
                                            <h4 style="margin: 0; font-weight: 600;">Donations:</h4>
                                            <button type="button" class="add-donation-btn" onclick="openAddDonationModal(${participantId})">
                                                + Add Donation
                                            </button>
                                        </div>
                                        <div class="no-donations">No donations found for this participant.</div>
                                    `;
                                }
                            }
                        }
                    }
                } else {
                    alert('Error: ' + (result.error || 'Failed to delete donation.'));
                }
            } catch (error) {
                console.error('Error deleting donation:', error);
                alert('An error occurred. Please try again.');
            }
        }

        // Save donation (add or edit)
        document.getElementById('saveDonationBtn').addEventListener('click', async function() {
            const donationId = document.getElementById('modalDonationId').value;
            const participantId = document.getElementById('modalParticipantId').value;
            const amount = document.getElementById('modalDonationAmount').value;
            const date = document.getElementById('modalDonationDate').value;

            if (!amount || parseFloat(amount) <= 0) {
                alert('Please enter a valid donation amount.');
                return;
            }

            if (!date) {
                alert('Please select a donation date.');
                return;
            }

            try {
                let response;
                if (donationId) {
                    // Edit existing donation
                    response = await fetch(`/api/donations/${donationId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            donationAmount: amount,
                            donationDate: date
                        })
                    });
                } else {
                    // Add new donation
                    response = await fetch('/api/donations/add', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            participantId: participantId,
                            donationAmount: amount,
                            donationDate: date
                        })
                    });
                }

                const result = await response.json();

                if (result.success) {
                    // Update total donations and total amount
                    loadDonationData();
                    
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('donationModal'));
                    modal.hide();
                    
                    // Reload donations for this participant
                    // Get participant info from the displayed info
                    const participantInfoDiv = document.getElementById('participantInfo');
                    if (participantInfoDiv && participantInfoDiv.innerHTML) {
                        const participantName = participantInfoDiv.querySelector('.participant-name')?.textContent || '';
                        const participantEmail = participantInfoDiv.querySelector('.participant-email')?.textContent || '';
                        
                        if (participantName && participantEmail) {
                            const nameParts = participantName.trim().split(/\s+/);
                            const firstName = nameParts[0] || '';
                            const lastName = nameParts.slice(1).join(' ') || '';
                            await selectParticipant(participantId, firstName, lastName, participantEmail);
                        } else {
                            // If we don't have the info, just reload the donations
                            const response = await fetch(`/api/donations/participant/${participantId}`);
                            const result = await response.json();
                            if (result.success) {
                                // Re-display donations
                                const donationsListDiv = document.getElementById('donationsList');
                                if (result.donations && result.donations.length > 0) {
                                    // Use the same display logic as selectParticipant
                                    let donationsHTML = `
                                        <div class="donations-header">
                                            <h4 style="margin: 0; font-weight: 600;">Donations:</h4>
                                            <button type="button" class="add-donation-btn" onclick="openAddDonationModal(${participantId})">
                                                + Add Donation
                                            </button>
                                        </div>
                                    `;
                                    result.donations.forEach(donation => {
                                        // Format date and amount (same logic as before)
                                        let formattedDate = 'Unknown Date';
                                        const dateStr = donation.donationdate;
                                        if (dateStr && dateStr !== 'UNKNOWN_DATE' && dateStr.trim() !== '') {
                                            const dateMatch = dateStr.match(/^(\d{4})-(\d{2})-(\d{2})/);
                                            if (dateMatch) {
                                                const year = parseInt(dateMatch[1], 10);
                                                const month = parseInt(dateMatch[2], 10) - 1;
                                                const day = parseInt(dateMatch[3], 10);
                                                const date = new Date(year, month, day);
                                                if (!isNaN(date.getTime())) {
                                                    formattedDate = date.toLocaleDateString('en-US', {
                                                        year: 'numeric',
                                                        month: 'long',
                                                        day: 'numeric'
                                                    });
                                                } else {
                                                    formattedDate = dateStr;
                                                }
                                            } else {
                                                const date = new Date(dateStr);
                                                if (!isNaN(date.getTime())) {
                                                    formattedDate = date.toLocaleDateString('en-US', {
                                                        year: 'numeric',
                                                        month: 'long',
                                                        day: 'numeric'
                                                    });
                                                } else {
                                                    formattedDate = dateStr;
                                                }
                                            }
                                        } else if (dateStr === 'UNKNOWN_DATE') {
                                            formattedDate = 'Unknown Date';
                                        }
                                        
                                        const formattedAmount = parseFloat(donation.donationamount || 0).toLocaleString('en-US', {
                                            style: 'currency',
                                            currency: 'USD',
                                            minimumFractionDigits: 2
                                        });
                                        
                                        let inputDate = 'UNKNOWN_DATE';
                                        if (dateStr && dateStr !== 'UNKNOWN_DATE' && dateStr.trim() !== '') {
                                            const dateMatch = dateStr.match(/^(\d{4})-(\d{2})-(\d{2})/);
                                            if (dateMatch) {
                                                inputDate = dateStr.substring(0, 10);
                                            } else {
                                                const date = new Date(dateStr);
                                                if (!isNaN(date.getTime())) {
                                                    const year = date.getFullYear();
                                                    const month = String(date.getMonth() + 1).padStart(2, '0');
                                                    const day = String(date.getDate()).padStart(2, '0');
                                                    inputDate = `${year}-${month}-${day}`;
                                                }
                                            }
                                        }
                                        
                                        donationsHTML += `
                                            <div class="donation-item">
                                                <div>
                                                    <div class="donation-date">${formattedDate}</div>
                                                </div>
                                                <div class="donation-amount">
                                                    ${formattedAmount}
                                                    <div class="donation-actions">
                                                        <button type="button" class="donation-action-btn" onclick="editDonation(${donation.donationid}, ${participantId}, ${donation.donationamount}, '${inputDate}')" title="Edit">
                                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                                            </svg>
                                                        </button>
                                                        <button type="button" class="donation-action-btn" onclick="deleteDonation(${donation.donationid}, ${participantId})" title="Delete">
                                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                            </svg>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    });
                                    donationsListDiv.innerHTML = donationsHTML;
                                } else {
                                    donationsListDiv.innerHTML = `
                                        <div class="donations-header">
                                            <h4 style="margin: 0; font-weight: 600;">Donations:</h4>
                                            <button type="button" class="add-donation-btn" onclick="openAddDonationModal(${participantId})">
                                                + Add Donation
                                            </button>
                                        </div>
                                        <div class="no-donations">No donations found for this participant.</div>
                                    `;
                                }
                            }
                        }
                    }
                } else {
                    alert('Error: ' + (result.error || 'Failed to save donation.'));
                }
            } catch (error) {
                console.error('Error saving donation:', error);
                alert('An error occurred. Please try again.');
            }
        });
        <% } %>
    </script>
</body>

</html>

